<link href="https://fonts.cdnfonts.com/css/liberation-mono" rel="stylesheet">
<link href="style.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<table>
    <tr>
        <td>
            <select id="SelectVersion">
                <option disabled selected>Select a version</option>
            </select>
        </td>
        <td>
            <select id="SearchType">
                <option>Search</option>
                <option disabled>Provides</option>
                <option disabled>Tags</option>
                <option>Info</option>
            </select>
        </td>
        <td>
            <input id="InputSearchTerm" style="border: 1px solid;"></input>
        </td>
    </tr>
</table>
<hr>
<table id=InfoTable>
    <tr>
        <td>
            <select id="TCZList" size="2"></select>
        </td>
        <td valign="top">
            <div id=InfoList><div>
        </td>
    </tr>
</table>

<script>
    var selectedVersion, selectedArch;

    $(document).ready(function () {
        $('#SelectVersion').change(function () {
            var selectedOption = $('#SelectVersion option:selected');
            selectedVersion = selectedOption.closest('optgroup').attr('label');
            selectedArch = selectedOption.val();

            $.get(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/data/${selectedVersion}/${selectedArch}/tczlist`, function (data) {
                $('#TCZList').empty();
                data.split('\n').forEach(line => {
                    $('#TCZList').append($('<option>', { text: line }));
                });
            });
        });

        $('#TCZList').change(function () {
            var selectedItem = $('#TCZList option:selected').text();
            var infoUrl = `https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/tinycorelinux/${selectedVersion}/${selectedArch}/tcz/${selectedItem}.info`;

            $.get(infoUrl, function (infoData) {
                var formattedInfo = infoData.replace(/\n/g, '<br>');
                $('#InfoList').html(formattedInfo);
                $('#InfoList').show()
            });
        });

        $('#InputSearchTerm').keypress(function (event) {
            if (event.which === 13) {
                var searchTerm = $('#InputSearchTerm').val().toLowerCase();
                var searchType = $('#SearchType option:selected').text().toLowerCase();

                if (searchType === 'search') {
                    $('#TCZList option').each(function () {
                        var itemText = $(this).text().toLowerCase();
                        $(this).toggle(itemText.includes(searchTerm));
                    });

                    searchTerm.length === 0 && $('#TCZList option').show();
                }
                if (searchType === 'Info') {
                    alert("All .info files will be searched. This search takes a long time.");
                    $('#TCZList').empty();
                    $.get(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/data/${selectedVersion}/${selectedArch}/tczlist`, function (data) {
                        var lines = data.split('\n');
                        lines.forEach(function (line) {
                            var fileName = line.trim();
                            $.get(`https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/tinycorelinux/${selectedVersion}/${selectedArch}/tcz/${fileName}.info`, function (infoData) {
                                if (infoData.toLowerCase().includes(searchTerm)) {
                                    $('#TCZList').append($('<option>', { text: fileName }));
                                }
                            });
                        });
                    });
                }
            }
        });

        $.get('https://raw.githubusercontent.com/CardealRusso/tinycore-online-repo/main/site-data/versions', function (data) {
            var jsonString = data.replace(/,\s*([\]}])/g, '$1');
            var parsedData = JSON.parse(jsonString);

            Object.keys(parsedData).sort((a, b) => parseInt(b) - parseInt(a)).forEach(version => {
                $('#SelectVersion').append(
                    $('<optgroup>', { label: version }).append(
                        parsedData[version].map(value => $('<option>', { value: value, text: value }))
                    )
                );
            });
        });
    });
</script>
